@{
    ViewBag.Title = "Drinks Management";
    Layout = "~/Views/Shared/Admin_Layout.cshtml";
}

<style>
    /* 1. Header Card */
    .page-header-card {
        background: linear-gradient(135deg, #1a3c1e 0%, #0f2b12 100%);
        color: white;
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

        .page-header-card::after {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 180px;
            height: 180px;
            background: rgba(197, 160, 89, 0.1);
            border-radius: 50%;
        }

    /* 2. Toolbar Card */
    .toolbar-card {
        background: #fff;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 1px solid rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .search-input {
        border: 2px solid #eee;
        border-radius: 8px;
        padding: 10px 15px;
        transition: 0.3s;
        width: 100%;
    }

        .search-input:focus {
            border-color: #c5a059;
            box-shadow: none;
            outline: none;
        }

    .btn-add-premium {
        background: linear-gradient(135deg, #c5a059 0%, #aa853c 100%);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

        .btn-add-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(197, 160, 89, 0.3);
            color: #fff;
        }

    #drinksContainer {
        min-height: 400px;
        transition: opacity 0.3s ease;
    }
</style>

<div class="container py-4">

    <div class="page-header-card">
        <div style="z-index: 1;">
            <h2 class="fw-bold mb-1" style="font-family: 'Playfair Display', serif;">Drink Menu</h2>
            <p class="mb-0 text-white-50">Manage your product catalog, prices, and availability.</p>
        </div>
        <div class="d-none d-md-block" style="z-index: 1;">
            <div class="bg-white text-dark rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 50px; height: 50px;">
                <i class="fas fa-cocktail fa-lg" style="color: #1a3c1e;"></i>
            </div>
        </div>
    </div>

    <div class="toolbar-card">
        <div class="row g-3 align-items-center">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 border-2" style="border-color: #eee;">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" id="searchBox" placeholder="Search drinks by name..." class="search-input border-start-0 ps-0" />
                </div>
            </div>
            <div class="col-md-4 text-end">
                <a asp-action="AddDrink" class="btn-add-premium w-100 justify-content-center">
                    <i class="fas fa-plus-circle"></i> Add New Product
                </a>
            </div>
        </div>
    </div>

    <div id="drinksContainer">
        <div class="text-center py-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-muted">Loading menu items...</p>
        </div>
    </div>
</div>

@section foot {
    <script>
        // Global State Variables
        var currentSort = "name"; // Default sort
        var currentPage = 1;

        // 1. Main Load Function
        function loadDrinks(page = currentPage, sort = currentSort, search = $("#searchBox").val()) {

            $("#drinksContainer").css("opacity", "0.6");

            $.get("/Admin/LoadDrinks", { page: page, sort: sort, search: search }, function (result) {
                // Inject HTML
                $("#drinksContainer").html(result).css("opacity", "1");

                // Update State
                currentPage = page;
                currentSort = sort;

                // Re-apply Arrows immediately after HTML injection
                updateDrinkArrows();
            });
        }

        // 2. Arrow Update Logic
        function updateDrinkArrows() {
            // Reset all to neutral
            $("#sort-name, #sort-price").html("⇅").css("opacity", "0.3");

            // Determine Arrow Direction
            var arrow = currentSort.endsWith("_desc") ? "↓" : "↑";

            // Apply to active column
            if (currentSort.startsWith("name")) {
                $("#sort-name").html(arrow).css("opacity", "1");
            }
            else if (currentSort.startsWith("price")) {
                $("#sort-price").html(arrow).css("opacity", "1");
            }
        }

        // 3. Event Listeners (Using Delegated Events for AJAX content)

        // Sorting Click
        $(document).on("click", ".sort-link", function (e) {
            e.preventDefault();
            var sortField = $(this).data("sort");

            // Toggle logic
            if (currentSort === sortField) {
                currentSort = currentSort.endsWith("_desc") ? sortField : sortField + "_desc";
            } else {
                currentSort = sortField;
            }

            // Reload
            loadDrinks(1, currentSort); // Reset to page 1 on sort
        });

        // Pagination Click
        $(document).on("click", ".load-page", function (e) {
            e.preventDefault();
            var page = $(this).data("page");
            loadDrinks(page, currentSort);
        });

        // Search Typing (Debounced)
        let timeout = null;
        $("#searchBox").on("keyup", function () {
            clearTimeout(timeout);
            var val = $(this).val();
            timeout = setTimeout(function () {
                loadDrinks(1, currentSort, val);
            }, 300);
        });

        // Initial Load
        $(document).ready(function () {
            loadDrinks();
        });
    </script>
}